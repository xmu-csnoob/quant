name: PR Template Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-template:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required sections
        id: template-check
        run: |
          # è·å–PR bodyå’Œlabels
          BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body')
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name')

          # æ£€æŸ¥è±å…labels
          SKIP_SECTIONS=""

          if echo "$LABELS" | grep -q "emergency-override"; then
            echo "âš ï¸ æ£€æµ‹åˆ° emergency-override labelï¼Œè·³è¿‡æ‰€æœ‰æ¨¡æ¿æ£€æŸ¥"
            exit 0
          fi

          if echo "$LABELS" | grep -q "docs-only"; then
            echo "ğŸ“ æ£€æµ‹åˆ° docs-only labelï¼Œè·³è¿‡æ¨¡æ¿æ£€æŸ¥ï¼ˆæ–‡æ¡£PRï¼‰"
            exit 0
          fi

          if echo "$LABELS" | grep -q "test-only"; then
            echo "ğŸ§ª æ£€æµ‹åˆ° test-only labelï¼Œè·³è¿‡éƒ¨åˆ†æ¨¡æ¿æ£€æŸ¥ï¼ˆçº¯æµ‹è¯•PRï¼‰"
            SKIP_SECTIONS="flowchart|invariants"
          fi

          ERRORS=""

          # æ£€æŸ¥è®¾è®¡æ‘˜è¦
          if echo "$BODY" | grep -q "## è®¾è®¡æ‘˜è¦"; then
            SECTION=$(echo "$BODY" | sed -n '/## è®¾è®¡æ‘˜è¦/,/^## /p' | head -n -1 | tail -n +2)
            # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å†…å®¹ï¼ˆç§»é™¤HTMLæ³¨é‡Šåï¼‰
            CONTENT=$(echo "$SECTION" | sed 's/<!--[^>]*-->//g' | grep -v '^[[:space:]]*$' | tr -d '\n')
            if [ -z "$CONTENT" ]; then
              ERRORS="$ERRORS\n- âŒ è®¾è®¡æ‘˜è¦: æœªå¡«å†™"
            else
              echo "âœ… è®¾è®¡æ‘˜è¦: å·²å¡«å†™"
            fi
          else
            ERRORS="$ERRORS\n- âŒ è®¾è®¡æ‘˜è¦: ç¼ºå°‘æ­¤section"
          fi

          # æ£€æŸ¥è°ƒç”¨é“¾/æ•°æ®æµå›¾ï¼ˆtest-onlyå¯è·³è¿‡ï¼‰
          if echo "$SKIP_SECTIONS" | grep -q "flowchart"; then
            echo "â­ï¸ è°ƒç”¨é“¾/æ•°æ®æµå›¾: å·²è·³è¿‡ï¼ˆtest-onlyï¼‰"
          else
            if echo "$BODY" | grep -q "## è°ƒç”¨é“¾/æ•°æ®æµå›¾"; then
              SECTION=$(echo "$BODY" | sed -n '/## è°ƒç”¨é“¾\/æ•°æ®æµå›¾/,/^## /p' | head -n -1 | tail -n +2)
              CONTENT=$(echo "$SECTION" | sed 's/<!--[^>]*-->//g' | grep -v '^[[:space:]]*$' | tr -d '\n')
              if [ -z "$CONTENT" ]; then
                ERRORS="$ERRORS\n- âŒ è°ƒç”¨é“¾/æ•°æ®æµå›¾: æœªå¡«å†™"
              else
                echo "âœ… è°ƒç”¨é“¾/æ•°æ®æµå›¾: å·²å¡«å†™"
              fi
            else
              ERRORS="$ERRORS\n- âŒ è°ƒç”¨é“¾/æ•°æ®æµå›¾: ç¼ºå°‘æ­¤section"
            fi
          fi

          # æ£€æŸ¥ä¸å˜é‡ä¸è¾¹ç•Œï¼ˆtest-onlyå¯è·³è¿‡ï¼‰
          if echo "$SKIP_SECTIONS" | grep -q "invariants"; then
            echo "â­ï¸ ä¸å˜é‡ä¸è¾¹ç•Œ: å·²è·³è¿‡ï¼ˆtest-onlyï¼‰"
          else
            if echo "$BODY" | grep -q "## ä¸å˜é‡ä¸è¾¹ç•Œ"; then
              SECTION=$(echo "$BODY" | sed -n '/## ä¸å˜é‡ä¸è¾¹ç•Œ/,/^## /p' | head -n -1 | tail -n +2)
              CONTENT=$(echo "$SECTION" | sed 's/<!--[^>]*-->//g' | grep -v '^[[:space:]]*$' | tr -d '\n')
              if [ -z "$CONTENT" ]; then
                ERRORS="$ERRORS\n- âŒ ä¸å˜é‡ä¸è¾¹ç•Œ: æœªå¡«å†™"
              else
                echo "âœ… ä¸å˜é‡ä¸è¾¹ç•Œ: å·²å¡«å†™"
              fi
            else
              ERRORS="$ERRORS\n- âŒ ä¸å˜é‡ä¸è¾¹ç•Œ: ç¼ºå°‘æ­¤section"
            fi
          fi

          # æ£€æŸ¥å¤ç°è„šæœ¬
          if echo "$BODY" | grep -q "## å¤ç°è„šæœ¬"; then
            SECTION=$(echo "$BODY" | sed -n '/## å¤ç°è„šæœ¬/,/^## /p' | head -n -1 | tail -n +2)
            CONTENT=$(echo "$SECTION" | sed 's/<!--[^>]*-->//g' | grep -v '^[[:space:]]*$' | tr -d '\n')
            if [ -z "$CONTENT" ]; then
              ERRORS="$ERRORS\n- âŒ å¤ç°è„šæœ¬: æœªå¡«å†™"
            else
              echo "âœ… å¤ç°è„šæœ¬: å·²å¡«å†™"
            fi
          else
            ERRORS="$ERRORS\n- âŒ å¤ç°è„šæœ¬: ç¼ºå°‘æ­¤section"
          fi

          # å¦‚æœæœ‰é”™è¯¯ï¼Œè¾“å‡ºå¹¶å¤±è´¥
          if [ -n "$ERRORS" ]; then
            echo ""
            echo "::error::PRæ¨¡æ¿æ£€æŸ¥å¤±è´¥ï¼Œä»¥ä¸‹å¿…å¡«sectionæœªå®Œæˆï¼š"
            echo -e "$ERRORS"
            echo ""
            echo "ERRORS<<EOF" >> $GITHUB_ENV
            echo -e "$ERRORS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            exit 1
          fi

          echo ""
          echo "âœ… æ‰€æœ‰å¿…å¡«sectionå·²å¡«å†™"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on incomplete template
        if: failure()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## âš ï¸ PR Template Check Failed

          ä»¥ä¸‹å¿…å¡«sectionæœªå®Œæˆï¼š

          ${{ env.ERRORS }}

          ### å¿…å¡«sectionè¯´æ˜
          1. **è®¾è®¡æ‘˜è¦**: æè¿°å˜æ›´çš„ç›®æ ‡ã€è¾“å…¥è¾“å‡ºã€ä¾èµ–ã€å¤±è´¥æ¨¡å¼ã€å›æ»šæ–¹æ¡ˆ
          2. **è°ƒç”¨é“¾/æ•°æ®æµå›¾**: æè¿°è¯·æ±‚å¦‚ä½•æµç»å„æ¨¡å—
          3. **ä¸å˜é‡ä¸è¾¹ç•Œ**: åˆ—å‡ºå¿…é¡»ä¸ºçœŸçš„æ¡ä»¶å’Œè¾¹ç•Œé™åˆ¶
          4. **å¤ç°è„šæœ¬**: æä¾›å¯è¿è¡Œçš„éªŒè¯å‘½ä»¤

          ### ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›
          - å¸®åŠ©reviewerå¿«é€Ÿç†è§£å˜æ›´æ„å›¾
          - ç¡®ä¿å…³é”®å†³ç­–è¢«è®°å½•
          - ä¾¿äºåç»­ç»´æŠ¤å’Œé—®é¢˜å®šä½

          ### Bypassæ ‡ç­¾
          å¦‚æœæ˜¯ç‰¹å®šç±»å‹çš„PRï¼Œå¯ä»¥æ·»åŠ ä»¥ä¸‹æ ‡ç­¾è·³è¿‡éƒ¨åˆ†æ£€æŸ¥ï¼š
          - \`test-only\`: çº¯æµ‹è¯•PRï¼Œè·³è¿‡"è°ƒç”¨é“¾/æ•°æ®æµå›¾"å’Œ"ä¸å˜é‡ä¸è¾¹ç•Œ"
          - \`docs-only\`: æ–‡æ¡£PRï¼Œè·³è¿‡æ‰€æœ‰æ¨¡æ¿æ£€æŸ¥
          - \`emergency-override\`: ç´§æ€¥ä¿®å¤ï¼Œè·³è¿‡æ‰€æœ‰æ£€æŸ¥

          è¯·å®Œå–„PRæè¿°åé‡æ–°æäº¤ã€‚
          "
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
