# 回测：检验策略效果

## 什么是回测？

**回测（Backtesting）** 就是用**历史数据**来检验你的策略。

**核心思想：** 如果这个策略在过去能赚钱，那么在未来可能也会赚钱。

## 回测的步骤

```
1. 准备历史数据
   ↓
2. 应用策略，生成交易信号
   ↓
3. 模拟交易（买入、卖出）
   ↓
4. 计算收益和风险
   ↓
5. 评估策略表现
```

## 回测的核心要素

### 1. 初始资金
```
初始资金 = 1,000,000 元（100万）
```

### 2. 交易成本
```
佣金：0.025%（万2.5）
印花税：0.1%（仅卖出）
滑点：0.1%（成交价偏差）
```

### 3. 每日模拟流程
```
for 每个交易日:
    1. 获取当日价格
    2. 根据策略生成信号
    3. 如果有买入信号：
       - 计算能买多少股
       - 扣除佣金，买入股票
    4. 如果有卖出信号：
       - 卖出股票
       - 扣除印花税和佣金
    5. 更新持仓和现金
    6. 记录当日总资产
```

## Python 简单回测示例

```python
def simple_backtest(df, initial_capital=100000):
    """
    简单回测函数

    Args:
        df: 包含价格和信号的DataFrame
        initial_capital: 初始资金

    Returns:
        最终资金和收益率
    """
    cash = initial_capital  # 现金
    shares = 0              # 持股数量
    position_value = 0      # 持股市值

    for i in range(len(df)):
        price = df.loc[i, '收盘']
        signal = df.loc[i, '信号']

        if signal == '买入' and shares == 0:
            # 全部买入（简化，不考虑最小手数）
            shares = int(cash / price)
            cash = cash - shares * price

        elif signal == '卖出' and shares > 0:
            # 全部卖出
            cash = cash + shares * price
            shares = 0

        # 计算当日总资产
        position_value = shares * price
        df.loc[i, '总资产'] = cash + position_value

    # 最终资产
    final_value = df['总资产'].iloc[-1]
    return_rate = (final_value - initial_capital) / initial_capital

    return final_value, return_rate
```

## 回测结果评估

### 收益率
```
总收益率 = (最终资产 - 初始资金) / 初始资金
```

### 年化收益
```
年化收益 = (1 + 总收益率)^(365/交易天数) - 1
```

### 最大回撤
```
最大回撤 = (峰值 - 谷底) / 峰值
```
**含义：** 从最高点到最低点跌了多少。

### 夏普比率（Sharpe Ratio）
```
夏普比率 = (年化收益 - 无风险利率) / 年化波动率
```
**含义：** 每承担一单位风险，获得多少收益。

## 回测的陷阱

### 1. 未来函数（Look-ahead Bias）
```
错误：用当天的收盘价决定当天的交易
正确：只能用昨天及之前的数据做决策
```

### 2. 过度拟合（Overfitting）
```
错误：为了适配历史数据，把策略调得过于复杂
结果：历史表现很好，实盘亏损
```

### 3. 交易成本被忽略
```
错误：不考虑佣金、印花税、滑点
结果：回测收益很高，实盘被手续费吃掉
```

### 4. 流动性不足
```
错误：假设随时能买卖任意数量
现实：小盘股可能买不到或卖不出
```

## 回测不能保证未来

**重要：** 历史表现 ≠ 未来表现

- 市场环境在变化
- 策略可能失效
- 需要持续监控和调整

## 下一步

理解了回测，我们就可以构建**完整的量化系统**——从数据获取、到策略开发、到回测检验、再到实盘交易。
